<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="order">
<insert id="insert" parameterType="ordervo">
		insert into orders values
		(
			(
				select CONCAT('ORD-',DATE_FORMAT(now(),'%y%m%d'), '-', LPAD(count(a.order_date) +1 ,5,0)) 
				from orders a where DATE_FORMAT(a.order_date,'%Y%m%d') = DATE_FORMAT(now() ,'%Y%m%d')
			), 
			#{id}, 			
			<choose>
			<when test="password == null or password ==''">
				<![CDATA[
					(select password from user where id = #{id}) ,	
				]]>
			</when>
			<otherwise>
				<![CDATA[
					#{password}, 
				]]>
			</otherwise>
		</choose>	
			#{name}, #{phone}, #{address}, 
			#{addressDetail}, #{status}, 
			now(), #{msg}, #{completeDate}, null
		)
		<selectKey keyProperty="orderNo" resultType="string" order="AFTER">
			select order_no as orderNo from orders order by order_no desc limit 1
		</selectKey>
	</insert>
	
	<insert id="insertProduct" parameterType="ordervo">
		insert into order_product values
		(
			#{quantity},
			#{size},
			#{color},
			#{price},
			#{orderNo},
			#{productNo}
		)
		<selectKey keyProperty="orderNo" resultType="string" order="AFTER">
			select order_no as orderNo from orders order by order_no desc limit 1
		</selectKey>
	</insert>
</mapper>
